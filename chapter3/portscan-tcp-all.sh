#!/bin/sh
# coding: UTF-8

# This code is based on https://github.com/oreilly-japan/pentest-starting-with-port-scanner
# https://github.com/oreilly-japan/pentest-starting-with-port-scanner/blob/main/code/chapter03/portscan-tcp-all.sh
# Kotake Taichi @Sterra Security Co.,Ltd., "pentest starting with port scanner", O'reilly Japan, ISBN 978-4-8144-0042-3

set -eu
# -e option : stop with error
# -u option : stop when undefined variables are used

# help messages
usage() {
    echo "Usage : ${0##*/} -T<0-5> <target-hosts.txt> <exclude-hosts.txt>"
}

cat $1
cat $2

# occur an error when this script is run wihtout any command line inputs
if [ "$#" -eq 0 ]; then
    echo "Error : Target hosts must be specified"
    usage
    exit 1
fi

if [ "$1" = "-h" ]; then
    usage
    exit 0
fi

# get date-and-time for the folder name
today=`date +%Y%m%d`

# create a folder to store the result
if [ ! -d ./results/${today} ]; then
    mkdir -p ./results/${today}
fi

# get date-and-time for the file name
now=`date +%Y%m%d_%H%M%S`

# store the input values to the variable
timing_template=$1
hosts=`cat $2`
echo "Target : ${hosts}"

if [ "$#" -eq 3 ]; then
    exclude_hosts=`cat $3`
    echo "Exclude Hosts : ${exclude_hosts}"
    exclude_option="--exclude ${exclude_hosts}"
else
    exclude_option=""
fi

for h in $hosts
do
    # CIDR
    host_name=`echo $h | tr "/" "_"`
    # TCP SYN Ping, SYN Scan
    # Output the result in XML and TXT files
    echo "Now Launching : sudo nmap ${exclude_option} -v -n -p- -PS22,80,443 -sS --host-timeout 30m\
-oX ./results/${today}/${host_name}_syn_ping_${now}.xml\
-oN ./results/${today}/${host_name}_syn_ping_${now}.txt ${h}"

    sudo nmap ${exclude_option} -v -n -p- -PS22,80,443 -sS --host-timeout 30m\
    -oX ./results/${today}/${host_name}_syn_ping_${now}.xml\
    -oN ./results/${today}/${host_name}_syn_ping_${now}.txt ${h}
done
